<!DOCTYPE html>
<html lang="zh-tw">
<!--TODO:
1. [css] right menu, able scroll
2. [css] right menu, left meun, @ viewport width < 1200px, hide, otherwise show
3. 標題應該要塞回去
-->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DOCX Preview</title>
  <!--區域1 反正就叫一堆CSS (區域起始)-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css"
    integrity="sha512-KXol4x3sVoO+8ZsWPFI/r5KBVB/ssCGB5tsv2nVOKwLg33wTFP3fmnXa47FdSVIshVTgsYk/1734xSk9aFIa4A=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/components/rail.min.css"
    integrity="sha512-5otZXyOy1WoHVUtIkCWTouUsd4FATLQxdn0iNNhwdi+Fsrfr2mZZf0nf8YyYJhhHQcHVhPsbCY3TvqfrmxURwQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- <script src="https://unpkg.com/jszip/dist/jszip.min.js"></script> -->
  <script src="../public/js/jszip.min.js"></script>
  <!-- <script src="https://unpkg.com/docx-preview/dist/docx-preview.min.js"></script> -->
  <script src="../public/js/docx-preview.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.2.2/css/dataTables.dataTables.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/components/table.min.css"
    integrity="sha512-LO7R36eoQTR8mctOTFrAUUGCBiqbouo0mzi5dicyVrW76ECJSI4leeTh3PIX4Hp+09++NA3TVFPRg/0C7viORA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/components/dropdown.min.css" integrity="sha512-tdyzfjYDk2OR9L10jvzzuGUB0Rvl5fyMW/Z8yfbYyyENfuXxtcDtEq7d/PdiA0hzQzXjWwvZasjEp8Joli2tkw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!--區域1 反正就叫一堆CSS (區域結束)-->
  <link rel="stylesheet" href="../public/main.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet">
  <!--區域三 字體 區域結束-->
</head>

<body>
  <!--區域四 主HTML 區域起始-->
  <!--本區HTML概述，一個docx主容器，一個loader，在docx主容器尚未渲染完成前，UI轉轉轉-->
  <script>var docxready = false;</script>
  <div id="loader" class="ui active inverted dimmer full-page-loader">
    <div class="ui large text loader">Loading</div>
  </div>
  <div id="container" style="display: none;"></div>
   <!--區域四 主HTML 區域結束            以下的部分不重要，真的不重要 一大段垃圾HTML 就是裝飾品          (區域:裝飾HTML 起始)                                   -->
  <div id="myFoot" class="ui  vertical footer segment" style="display: none;">
    <div class="ui center aligned container">
      <div class="ui stackable grid">
        <div class="two wide column"></div>
        <div class="four wide column">
          <h4 class="ui header">Info</h4>
          <!--問客戶這裡要放啥-->
          <div class="ui link list">
            <a class="item" href="#" target="_blank" id="updd">更新日期</a>
            <a class="item" href="#" target="_blank" id="updt">更新時間</a>
          </div>
        </div>
        <div class="five wide right floated column">
          <h4 class="ui header">Help Preserve This Project</h4>
          <p> Support for the continued development of Semantic UI comes directly from the community.</p>
          <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">
            <input type="hidden" name="cmd" value="_s-xclick">
            <input type="hidden" name="hosted_button_id" value="7ZAF2Q8DBZAQL">
            <button type="submit" class="ui large teal button">Donate Today</button>
          </form>
        </div>
        <div class="two wide column">

        </div>
      </div>
      <div class="ui section divider"></div>
      <img src="/images/logo.png" class="ui centered mini image">
      <div class="ui horizontal small divided link list">
        <a class="item" href="http://semantic-ui.mit-license.org/" target="_blank">Free &amp; Open Source (MIT)</a>
      </div>
    </div>
  </div>
<!--  (區域:裝飾HTML 結束)       -->
  
  <script>
    fetch('/docxView/內科.docx')
      .then(response => response.blob())
      .then(blob => {
        //這裡做一件事，onenote輸出整個筆記是整個章，沒分節，分節的方式用日期，所以就是英文日期中文日期regex
        var docData = blob;
        docx.renderAsync(docData, document.getElementById("container"))
          .then(x => {//docx 終於被載入了
            console.log("docx: finished");
            const docxElement = document.getElementsByClassName('docx')[0];
            const elements = Array.from(docxElement.querySelectorAll('*'));
            var rightMenu = '';
            //這段就是要分節
            const pattern1 = /\d{4}年\d{1,2}月\d{1,2}日\s*[上下]午\s*\d{1,2}:\d{1,2}/;
            const pattern2 = /\b[^\(\)（）:\d\s]+,\s[^\(\)（）:\d\s]+\s\d{1,2},\s\d{4}\s*\d{1,2}:\d{1,2}\s[AP]M\b/;
            var hashIDX = 1;
            for (let i = 1; i < elements.length; i++) {
              const el = elements[i];

              const nextSiblingText = el.nextSibling?.innerText || ''; // Handle missing nextSibling safely
              const line2_push = el.innerText + nextSiblingText;

              if (pattern1.test(line2_push)) {//每遇到一個節標題就存到右側目錄中
                rightMenu += `<a class="item" href="#${hashIDX + 1}" onclick="if (event.target.tagName === 'A') {event.preventDefault(); window.location.href = event.target.href;  window.location.reload();  }">${el.previousSibling.innerText}</a>`;
                hashIDX++;
                el.style.display = 'none';
                el.nextSibling.style.display = 'none';
                if (hashIDX === currentStage3index) {//然後非URL中的小節數就隱藏
                  //順便抓大標
                  const h1 = document.createElement('h1');
                  h1.textContent = el.previousSibling.innerText;
                  h1.id = "thePageTitle";
                  // Set the styles for the h1 element
                  h1.style.backgroundColor = '#DAE5F4';
                  h1.style.position = 'fixed';
                  h1.style.top = '0';
                  h1.style.left = '50%';
                  h1.style.transform = 'translateX(-50%)';
                  h1.style.whiteSpace = 'nowrap';
                  h1.style.padding = '2vh 2vw';
                  h1.style.borderRadius = '10px';
                  h1.style.marginBlockStart = '0';
                  h1.style.zIndex = '9998';
                  document.body.appendChild(h1);
                  document.getElementById('updd').innerText = el.innerText;
                  document.getElementById('updt').innerText = nextSiblingText;
                }
              }

              //這段跟剛剛那段一樣，只是一個抓英文一個抓中文
              if (pattern2.test(line2_push)) {
                rightMenu += `<a class="item" href="#${hashIDX + 1}" onclick="if (event.target.tagName === 'A') {event.preventDefault(); window.location.href = event.target.href;  window.location.reload();  }">${el.previousSibling.innerText}</a>`;
                hashIDX++;
                el.style.display = 'none';
                el.nextSibling.style.display = 'none';
                if (hashIDX === currentStage3index) {
                  const h1 = document.createElement('h1');
                  h1.textContent = el.previousSibling.innerText;
                  h1.id = "thePageTitle";
                  // Set the styles for the h1 element
                  h1.style.backgroundColor = '#DAE5F4';
                  h1.style.position = 'fixed';
                  h1.style.top = '0';
                  h1.style.left = '50%';
                  h1.style.transform = 'translateX(-50%)';
                  h1.style.whiteSpace = 'nowrap';
                  h1.style.padding = '2vh 2vw';
                  h1.style.borderRadius = '10px';
                  h1.style.marginBlockStart = '0';
                  h1.style.zIndex = '9998';
                  document.body.appendChild(h1);
                  document.getElementById('updd').innerText = el.innerText;
                  document.getElementById('updt').innerText = nextSiblingText;
                }
              }

              if (hashIDX !== currentStage3index || (pattern1.test((el.nextSibling?.innerText || '') + (el.nextSibling?.nextSibling?.innerText || '')) || pattern2.test((el.nextSibling?.innerText || '') + (el.nextSibling?.nextSibling?.innerText || '')))) {
                el.style.display = 'none';//好，幹我忘記隱藏的邏輯到底是啥了，我道歉，前面不是隱藏過了這裡還要隱藏...by andy
              }

            }
            document.getElementsByClassName('docx-wrapper')[0].classList.add('ui');//這裡就開始套UI框架
            document.getElementsByClassName('docx-wrapper')[0].classList.add('segment');
            fetchCategories().then(leftMenu => {//然後這段加左右選單
              document.getElementsByClassName('docx-wrapper')[0].innerHTML = `
<div class="ui top fixed menu">
  <div class="header item" onclick="window.location.href='https://diagmindtw.com/'" id="button_back_to_landing_page">diagmindtw</div>
  <a class="active item">Link</a>
  <a class="item">Link</a>
  <div class="ui dropdown item" tabindex="0">
    工程模式(這個按鈕在部屬到生產環境時要移除)
    <i class="dropdown icon"></i>
    <div class="menu" tabindex="-1">
      <div class="item" id="DEVgenJSON" onclick="document_getElementById_DEVgenJSON_addEventListener_click_function()">生成(並下載)JSON</div>
      <div class="divider"></div>
      <div class="item" id="DEVviewJSON" onclick="document_getElementById_DEVviewJSON_addEventListener_click_function()"> (生成並)檢視JSON</div>
      <!--document_getElementById_DEVdownloadMarkdown_addEventListener_click_function-->
      <div class="divider"></div>
      <div class="item" id="DEVdownloadMarkdown" onclick="document_getElementById_DEVdownloadMarkdown_addEventListener_click_function()"> 下載Markdown</div>
      
    </div>
  </div>
  <div class="right menu">
    <div class="item">
      <div class="ui action left icon input">
        <i class="search icon"></i>
        <input type="text" placeholder="Search">
        <button class="ui button">Submit</button>
      </div>
    </div>
    <a class="item">Link</a>
  </div>
</div>
<div class="ui vertical menu menu-wrapper" id="leftMenuWrapper" style="left: 0;">
  <div class="ui left fixed vertical menu" id="leftMenu">
    ${leftMenu}
  </div>
  <div id="leftMenuToggle">
    <i class="ui angle left icon"></i>
  </div>
</div>
<div class="ui vertical menu menu-wrapper" id="rightMenuWrapper" style="right: 0;">
  <div class="ui right fixed vertical menu" id="rightMenu">
    ${rightMenu}
  </div>
  <div id="rightMenuToggle">
    <i class="ui angle right icon"></i>
  </div>
</div>
<div class="ui bottom fixed menu">
  <div class="item">
    <img src="/images/logo.png">
  </div>
  <a class="item">Features</a>
  <a class="item">Testimonials</a>
  <a class="item">Sign-in</a>
</div>
`+ hardfont(document.getElementsByClassName('docx-wrapper')[0].innerHTML);//然後這段改字體
            // 調整選單高度
            adjustVerticalMenuTop();

            // 讓選單可以收起來
            const leftMenuWrapper = document.getElementById('leftMenuWrapper');
            const rightMenuWrapper = document.getElementById('rightMenuWrapper');
            const leftMenuToggle = document.getElementById('leftMenuToggle');
            const rightMenuToggle = document.getElementById('rightMenuToggle');
            setupMenuToggle(leftMenuWrapper, leftMenuToggle, 'left');
            setupMenuToggle(rightMenuWrapper, rightMenuToggle, 'right');

            // 調整內文位置
            adjustDocxPosition();

            // 設置點擊內文時收起選單的功能
            const article = document.querySelector('.docx article');
            article.addEventListener('click', () => {
              if (window.innerWidth < 850 && leftMenuWrapper.style?.transform !== 'translateX(-100%)') {
                  leftMenuToggle.click();
              }
              if (window.innerWidth < 1200 && rightMenuWrapper.style?.transform !== 'translateX(100%)') {
                  rightMenuToggle.click();
              }
            });

            docxready = true;
            });
          });
      })
      .catch(error => console.error('Error fetching the DOCX file:', error));
  </script>
  <!--以下的套件引入供「docx後處裡」使用-->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.js"
    integrity="sha512-Xo0Jh8MsOn72LGV8kU5LsclG7SUzJsWGhXbWcYs2MAmChkQzwiW/yTQwdJ8w6UA9C6EVG18GHb/TrYpYCjyAQw=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.datatables.net/2.2.2/js/dataTables.min.js" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/components/dropdown.min.js" integrity="sha512-PD2QRjH0s7TFz8Oicpi4UFJBdKP0vFeYpmNPsEoNDHfG3QcGLTs8XUrkXWEQXX2Q0g+1oEwvow27TM2VfPdTxw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="../public/utli/nest2json.js"></script>
  <script src="../public/utils.js"></script>
  <script src="../public/docx-loader.js"></script>
  <script src="../public/docx-postprocess.js"></script>
  <!--移除所有原本的 <style> 和 <script> 區塊，已經分離到外部檔案-->
</body>
</html>
